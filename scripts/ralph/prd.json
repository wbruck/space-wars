{
  "project": "Galaxy Selection Screen",
  "branchName": "ralph/galaxy-selection",
  "description": "Replace the current setup screen with a Galaxy Selection screen — a 3x3 grid of boards with random size and difficulty that the player traverses sequentially, with progress persisted in localStorage.",
  "userStories": [
    {
      "id": "US-050",
      "title": "Create galaxy state data model",
      "description": "As a developer, I need a data structure to represent the 3x3 galaxy grid so that each board tracks its size, difficulty, and completion status.",
      "background": "The game currently has no meta-progression — each game is standalone with manual size/difficulty selection via SetupScreen. This story creates the foundational data model in a new `src/lib/game/galaxy.js` module. The galaxy is a 3x3 grid of 9 boards. Board (0,0) starts unlocked; all others start locked. Each board has a deterministic seed so `initGame(cols, rows, seed, difficulty)` produces the same board layout.",
      "implementation": "Create `src/lib/game/galaxy.js` with a `generateGalaxy()` function. Galaxy state must be a plain serializable object (no class instances) for JSON localStorage persistence. Use a seeded RNG (consistent with existing xorshift32 pattern in the codebase) to generate board seeds, sizes, and difficulties. Size mappings reuse existing constants: Small=5x4, Medium=7x6, Large=9x8. Difficulty range is 7-20. Board object structure: { row (0-2), col (0-2), size ('small'|'medium'|'large'), cols (5|7|9), rows (4|6|8), difficulty (7-20), seed (number), status ('locked'|'unlocked'|'won'|'lost') }. FR-1: Galaxy is a 3x3 grid of 9 boards with randomly assigned size and difficulty. FR-2: Each board has a deterministic seed. FR-3: Top-left board (0,0) is unlocked at start; all others start locked. Non-goals: no difficulty progression by position (fully random), no multiple save slots.",
      "acceptanceCriteria": [
        "Create `src/lib/game/galaxy.js` with a `generateGalaxy()` function",
        "Galaxy is a 3x3 grid (9 boards), each board has: row, col, size (random: small/medium/large), difficulty (random: 7-20), status ('locked'|'unlocked'|'won'|'lost'), and a seed (for deterministic board generation)",
        "Board at position (0,0) starts with status 'unlocked'; all others start 'locked'",
        "Write unit tests for generateGalaxy() verifying grid structure, starting board status, and randomized size/difficulty distribution",
        "All tests pass",
        "Commit with message starting with 'US-050'"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-051",
      "title": "Implement galaxy adjacency and unlock logic",
      "description": "As a developer, I need adjacency logic so that winning a board unlocks its 8-directional neighbors.",
      "background": "The galaxy grid uses 8-directional adjacency (up, down, left, right, and all 4 diagonals). Winning a board unlocks adjacent locked boards. Lost boards are permanently locked and cannot be replayed, so the player must find alternate paths through the grid. This creates strategic depth — losing a board blocks that route.",
      "implementation": "Add functions to `src/lib/game/galaxy.js`. `getAdjacentBoards(row, col)` returns an array of {row, col} objects for valid 8-directional neighbors, bounds-checked to the 0-2 range. Corner boards (0,0), (0,2), (2,0), (2,2) have 3 neighbors. Edge boards (0,1), (1,0), (1,2), (2,1) have 5 neighbors. Center board (1,1) has 8 neighbors. `unlockAdjacentBoards(galaxy, row, col)` mutates the galaxy grid in place — only changes boards with status 'locked' to 'unlocked', must NOT overwrite 'won' or 'lost' statuses. This function is called after a board is won (never after a loss). FR-4: Adjacency is 8-directional. FR-5: Winning a board unlocks all adjacent locked boards. FR-6: Losing a board permanently locks it. Non-goal: no undo/retry for lost boards.",
      "acceptanceCriteria": [
        "Add `getAdjacentBoards(row, col)` function that returns all valid neighbors (8-directional: up, down, left, right, and all 4 diagonals)",
        "Add `unlockAdjacentBoards(galaxy, row, col)` function that sets adjacent 'locked' boards to 'unlocked' (does not change 'won' or 'lost' boards)",
        "Corner boards have 3 neighbors, edge boards have 5, center board has 8",
        "Write unit tests verifying adjacency counts for corner, edge, and center positions",
        "Write unit tests verifying unlock does not overwrite 'won' or 'lost' statuses",
        "All tests pass",
        "Commit with message starting with 'US-051'"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-052",
      "title": "Implement galaxy persistence with localStorage",
      "description": "As a player, I want my galaxy progress saved so that I can close the browser and resume later.",
      "background": "The current codebase has NO persistence — all state is in-memory Svelte stores. This story introduces localStorage for the first time. Galaxy progress must survive page refreshes and browser restarts so the player can resume their traversal.",
      "implementation": "Add persistence functions to `src/lib/game/galaxy.js`. Store galaxy state under the key 'galaxyProgress' in localStorage. Galaxy state is a plain serializable object (no class instances), so `JSON.stringify()` / `JSON.parse()` is sufficient. `saveGalaxy(galaxy)` — serialize and write to localStorage. `loadGalaxy()` — read from localStorage and deserialize, return `null` if key doesn't exist or parse fails. `clearGalaxy()` — remove the 'galaxyProgress' key from localStorage. Galaxy is saved after every board completion (win or loss) — called from the board completion handler (US-055). For unit tests, mock localStorage using a simple in-memory object or vitest's built-in mocking. FR-8: Galaxy progress is persisted to localStorage and restored on page load.",
      "acceptanceCriteria": [
        "Add `saveGalaxy(galaxy)` function that serializes galaxy state to localStorage under key 'galaxyProgress'",
        "Add `loadGalaxy()` function that deserializes and returns saved galaxy, or null if none exists",
        "Add `clearGalaxy()` function that removes saved galaxy from localStorage",
        "Galaxy is saved after every board completion (win or loss)",
        "Write unit tests for save/load/clear using mock localStorage",
        "All tests pass",
        "Commit with message starting with 'US-052'"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-053",
      "title": "Create GalaxySelection component with 3x3 grid UI",
      "description": "As a player, I want to see a 3x3 grid of boards so I can choose which board to play next.",
      "background": "This is the main new screen that replaces SetupScreen. It displays the galaxy as a visual 3x3 grid where each cell represents a board. The player can only click on unlocked boards. Won boards show green, lost boards show red, locked boards are dimmed gray. The component follows the same prop-based data flow pattern as Board.svelte (no direct store subscriptions).",
      "implementation": "Create `src/lib/components/GalaxySelection.svelte` as a new Svelte 5 component. Receives galaxy grid data as a prop and an `onSelectBoard(row, col)` callback prop. Uses Svelte 5 runes: `let { galaxy, onSelectBoard } = $props();`. Does NOT subscribe to stores directly — receives all data via props (consistent with Board.svelte pattern). Use CSS Grid: `display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);`. Each cell shows: size label (Small/Medium/Large), difficulty number, and visual status. Status styling: 'won' = green background/border, 'lost' = red background/border (not clickable), 'unlocked' = highlighted/glowing border (clickable, cursor: pointer), 'locked' = dimmed gray (not clickable). Title 'Galaxy Selection' displayed above grid. Mobile: min touch target 44px per cell, `touch-action: manipulation`. Accessibility: clickable cells need `role='button'`, `tabindex='0'`, `onkeydown` for keyboard nav. Reuse existing dark background / sci-fi aesthetic. FR-7: Only unlocked boards are selectable. Non-goals: no visual map/path lines, no board preview, no animations between screens.",
      "acceptanceCriteria": [
        "Create `src/lib/components/GalaxySelection.svelte` component",
        "Display 9 boards in a 3x3 CSS grid layout",
        "Each board cell shows: board size label (Small/Medium/Large), difficulty number, and visual status indicator",
        "Status colors: green background/border for 'won', red for 'lost', highlighted/glowing border for 'unlocked' (selectable), dimmed/gray for 'locked'",
        "Locked and lost boards are not clickable",
        "Unlocked boards are clickable and call an `onSelectBoard(row, col)` callback",
        "Won boards are not clickable (already completed)",
        "Screen has a title 'Galaxy Selection' at the top",
        "Responsive layout that works on mobile (min touch target 44px per board cell)",
        "Verify in browser using dev-browser skill",
        "Commit with message starting with 'US-053'"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-054",
      "title": "Integrate galaxy phase into game flow",
      "description": "As a developer, I need to add a 'galaxy' game phase so the App routes to the GalaxySelection screen.",
      "background": "The current game flow starts at 'setup' phase (SetupScreen) where the player manually picks size and difficulty. This story replaces that entry point with a 'galaxy' phase that shows the GalaxySelection screen. When a board is selected, the game transitions to the existing gameplay loop. The 'setup' phase is replaced entirely by 'galaxy' as the new entry point.",
      "implementation": "Add new Svelte writable stores in `src/lib/game/gameState.js`: `export const galaxyState = writable(null);` and `export const currentBoardPos = writable(null);` (holds {row, col} of board being played). Change `resetGame()` to set `gamePhase` to 'galaxy' instead of 'setup'. In App.svelte: import GalaxySelection component and galaxyState/currentBoardPos stores. On mount, check `loadGalaxy()` — if saved galaxy exists, load into galaxyState store; otherwise call `generateGalaxy()` and set store. Set initial phase to 'galaxy'. Route `gamePhase === 'galaxy'` → render GalaxySelection with galaxy data and onSelectBoard handler. `handleSelectBoard(row, col)`: look up board at (row,col) from galaxy, call `initGame(board.cols, board.rows, board.seed, board.difficulty)`, set currentBoardPos to {row, col}. `initGame()` already accepts (cols, rows, seed, difficulty) — no changes needed. Phase flow: 'galaxy' → select board → 'rolling' → gameplay loop → 'won'/'lost' → GameOver → update galaxy → 'galaxy'. FR-12 (partial): The 'setup' phase is replaced by 'galaxy'.",
      "acceptanceCriteria": [
        "Add 'galaxy' as a new gamePhase value",
        "Add a `galaxyState` Svelte store in gameState.js to hold the current galaxy grid",
        "resetGame() now sets phase to 'galaxy' instead of 'setup' (galaxy replaces setup as the landing screen)",
        "On app load, check localStorage for saved galaxy: if found, load it and go to 'galaxy' phase; if not, generate a new galaxy and go to 'galaxy' phase",
        "App.svelte renders GalaxySelection when phase is 'galaxy'",
        "When a board is selected, call initGame(cols, rows, seed, difficulty) using that board's properties, store the selected board's (row, col) for later, and transition to gameplay",
        "Verify in browser using dev-browser skill",
        "All tests pass",
        "Commit with message starting with 'US-054'"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-055",
      "title": "Handle board completion and return to galaxy",
      "description": "As a player, after I finish a board (win or lose), I want to see the result and return to the galaxy with my progress updated.",
      "background": "Currently `handlePlayAgain()` in App.svelte calls `resetGame()` which goes to 'setup'. This needs to be replaced with galaxy-aware logic that updates the board's status, unlocks neighbors on win, persists to localStorage, and returns to the galaxy grid. Lost boards are permanently locked (red) and cannot be replayed.",
      "implementation": "Replace `handlePlayAgain()` with `handleContinue()` in App.svelte. Flow: 1) Read `currentBoardPos` store to get {row, col} of the board just played. 2) Read `gamePhase` to determine win or loss ('won' or 'lost'). 3) Update the galaxy grid: set `galaxy[row][col].status` to 'won' or 'lost'. 4) If won: call `unlockAdjacentBoards(galaxy, row, col)` to unlock neighbors. 5) Call `saveGalaxy(galaxy)` to persist to localStorage. 6) Update `galaxyState` store with the modified galaxy (must trigger reactive updates). 7) Check `isGalaxyComplete(galaxy)` — if true, set phase to 'galaxyComplete'; otherwise set phase to 'galaxy'. Reset `currentBoardPos` to null when returning to galaxy. FR-5: Winning sets board to 'won' (green) and unlocks adjacent. FR-6: Losing sets board to 'lost' (red) permanently. FR-8: Galaxy saved after every completion.",
      "acceptanceCriteria": [
        "After the GameOver screen 'Continue' button is clicked, update the galaxy board status: set to 'won' if player won, 'lost' if player lost",
        "If the board was won, unlock all adjacent locked boards using unlockAdjacentBoards()",
        "Save updated galaxy to localStorage",
        "Transition back to 'galaxy' phase so player sees the updated grid",
        "Won board shows green on the galaxy grid",
        "Lost board shows red on the galaxy grid and is no longer selectable",
        "Verify in browser using dev-browser skill",
        "All tests pass",
        "Commit with message starting with 'US-055'"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-056",
      "title": "Detect galaxy completion and show summary",
      "description": "As a player, when I've resolved all reachable boards in the galaxy, I want to see a summary of my performance.",
      "background": "The galaxy is complete when no boards have status 'unlocked' — all are either won, lost, or locked (unreachable because adjacent boards were all lost). This check runs after every board completion. The summary shows aggregate stats and offers a 'New Galaxy' button to start fresh.",
      "implementation": "Add `isGalaxyComplete(galaxy)` to `src/lib/game/galaxy.js` — returns true when no board in the 3x3 grid has status 'unlocked'. Create `src/lib/components/GalaxyComplete.svelte` — receives galaxy data as a prop. Display counts: won (green), lost (red), unreachable/locked (gray). 'New Galaxy' button: calls `clearGalaxy()` to remove localStorage, calls `generateGalaxy()` to create fresh galaxy, updates `galaxyState` store, sets phase to 'galaxy'. Add 'galaxyComplete' as a new gamePhase value. App.svelte routes `gamePhase === 'galaxyComplete'` → render GalaxyComplete. The completion check happens in handleContinue (US-055) before transitioning to galaxy phase. FR-9: When no unlocked boards remain, galaxy is complete. FR-10: Galaxy complete screen shows win/loss/unreachable counts and New Galaxy button. FR-11: New Galaxy button clears localStorage and generates fresh galaxy.",
      "acceptanceCriteria": [
        "Add `isGalaxyComplete(galaxy)` function that returns true when no boards have status 'unlocked'",
        "Create `src/lib/components/GalaxyComplete.svelte` component",
        "Summary shows: total boards won (green count), total boards lost (red count), total boards unreachable (locked count)",
        "Display a 'New Galaxy' button that clears localStorage and generates a fresh galaxy",
        "App.svelte renders GalaxyComplete when galaxy is complete (new phase 'galaxyComplete')",
        "After returning from a board, check isGalaxyComplete() before going to galaxy phase — if complete, go to 'galaxyComplete' phase instead",
        "Write unit tests for isGalaxyComplete() with various galaxy states",
        "Verify in browser using dev-browser skill",
        "All tests pass",
        "Commit with message starting with 'US-056'"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-057",
      "title": "Update GameOver screen for galaxy flow",
      "description": "As a player, the GameOver screen should reflect that I'm returning to the galaxy, not restarting a standalone game.",
      "background": "The current GameOver screen has a 'Play Again' button that calls `onPlayAgain()` which triggers `resetGame()` → 'setup' phase. With the galaxy system, the player returns to the galaxy grid instead. All existing stats (moves made, points remaining, board size, loss reason) remain unchanged.",
      "implementation": "In `src/lib/components/GameOver.svelte`: change button text from 'Play Again' to 'Return to Galaxy'. The callback prop should be renamed or repurposed: `onPlayAgain` → `onContinue` (or keep the same prop name but change the handler in App.svelte). All existing stats remain: moves made (`$movesMade`), points remaining (`$movementPool`, win only), board size, and contextual loss reason (`$loseReason`). No other UI changes — just the button text and flow.",
      "acceptanceCriteria": [
        "Change 'Play Again' button text to 'Return to Galaxy'",
        "Remove the standalone 'Play Again' flow (no longer resets to setup screen)",
        "GameOver still shows all existing stats (moves made, points remaining, board size, loss reason)",
        "Verify in browser using dev-browser skill",
        "Commit with message starting with 'US-057'"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-058",
      "title": "Remove legacy SetupScreen",
      "description": "As a developer, I want to remove the old SetupScreen since the Galaxy Selection screen replaces it.",
      "background": "With the galaxy system fully integrated, the old SetupScreen component and 'setup' game phase are dead code. This cleanup story removes all traces of the old flow to prevent confusion.",
      "implementation": "Delete `src/lib/components/SetupScreen.svelte`. In `src/App.svelte`: remove `import SetupScreen` and the `gamePhase === 'setup'` routing branch. In `src/lib/game/gameState.js`: remove any remaining 'setup' references (resetGame should already point to 'galaxy' from US-054). Update any test files referencing 'setup' phase (check `gameState.test.js`, `winLose.test.js`). Verification: grep for 'SetupScreen' and 'setup' in src/ should return no hits related to the old setup flow. All existing tests must still pass after cleanup. FR-12: The legacy SetupScreen and 'setup' game phase are removed.",
      "acceptanceCriteria": [
        "Remove `SetupScreen.svelte` component file",
        "Remove the 'setup' phase routing from App.svelte",
        "Remove any imports or references to SetupScreen across the codebase",
        "Verify no dead code remains related to the old setup flow",
        "All tests pass (update any tests that reference 'setup' phase)",
        "Verify in browser using dev-browser skill",
        "Commit with message starting with 'US-058'"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    }
  ]
}
